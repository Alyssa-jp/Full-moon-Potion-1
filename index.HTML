<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Pisces Eclipse Potion</title>
<style>
  :root{ --pour-threshold:26; --accent:#ff6aa6; }
  html,body{margin:0;height:100%;background:#0b0e16;color:#eaf6ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{min-height:100dvh;display:grid;place-items:center;background:url("bg.jpg") center/cover no-repeat;padding:16px}
  .stage{position:relative;width:min(92vw,520px);aspect-ratio:1/1;isolation:isolate}

  /* 瓶（あなたのイラストをそのまま使用） */
  .bottle{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
  .bottle img{width:100%;height:auto;filter:drop-shadow(0 12px 30px rgba(0,0,0,.45))}
  
  /* フタ（簡易SVG。後でcap.pngに差し替え可） */
  .cap{position:absolute;left:50%;top:16%;width:36%;translate:-50% 0;transition:transform .45s cubic-bezier(.2,.8,.2,1), opacity .2s;transform-origin:50% 100%;z-index:3}
  .cap svg{width:100%;height:auto;filter:drop-shadow(0 6px 16px rgba(0,0,0,.35))}
  .cap.open{transform:translate(-50%,-70%) rotate(-18deg);} /* 開封アニメ（浮かぶ） */
  .cap.hidden{opacity:0}

  /* 注ぎエフェクト（瓶の口あたりに配置） */
  .pour{position:absolute;left:60%;top:31%;width:5px;height:0;border-radius:3px;
        background:linear-gradient(#ffd1e3,#ff9cc4, rgba(255,108,166,0));
        box-shadow:0 0 14px #ff7fb280; transform-origin:top; opacity:0; transition:opacity .12s}
  .glow{position:absolute;bottom:6%;left:50%;translate:-50% 0;width:56%;height:18%;
        background:radial-gradient(ellipse at center, rgba(255,122,178,.32), rgba(255,122,178,.08) 45%, transparent 70%);
        filter:blur(2px);opacity:0;transition:opacity .2s}
  .sparkles{position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity .15s}
  .sp{position:absolute;width:6px;height:6px;border-radius:50%;background:#fff;box-shadow:0 0 8px #fff8;
      animation:float 1.8s ease-in-out infinite}
  @keyframes float{0%{transform:translate(0,0) scale(1)}50%{transform:translate(-6px,-18px) scale(1.3)}100%{transform:translate(0,0) scale(1)}}

  /* UI */
  .hud{position:fixed;inset:auto 0 0 0;padding:12px 16px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.35));display:grid;gap:10px}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .btn{border:1px solid #2a3648;background:#141b27;color:#eaf6ff;padding:8px 12px;border-radius:10px;font-weight:600}
  .note{font-size:12px;opacity:.8}
  input[type=range]{width:100%}
  .brand{position:fixed;top:10px;left:50%;translate:-50% 0;font-size:12px;opacity:.7;letter-spacing:.12em;text-transform:uppercase}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage" id="stage">
    <div class="bottle"><img src="bottle.png" alt="Potion bottle"></div>

    <!-- フタ（仮のSVG）→ cap.png が用意できたら <img src="cap.png"> に差し替えOK -->
    <div class="cap" id="cap" aria-label="Cap">
      <svg viewBox="0 0 200 160" aria-hidden="true">
        <!-- ピンクの栓 -->
        <ellipse cx="100" cy="120" rx="70" ry="22" fill="#ff98c2"/>
        <rect x="60" y="70" width="80" height="55" rx="16" fill="#ffa4cc"/>
        <!-- 金の三日月（雰囲気だけ） -->
        <path d="M100,40 a30,30 0 1,0 40,45 a22,22 0 1,1 -40,-45" fill="#ffd16b"/>
      </svg>
    </div>

    <!-- 注ぎエフェクト -->
    <div class="pour" id="pour"></div>
    <div class="sparkles" id="sparkles"></div>
    <div class="glow" id="glow"></div>
  </div>
</div>

<div class="brand">Pisces Eclipse Potion — © Alyssa</div>
<div class="hud">
  <div class="row">
    <button class="btn" id="openBtn">Open cap</button>
    <button class="btn" id="permBtn" style="display:none">Enable Motion</button>
    <span class="note" id="status">Open the cap, then tilt to pour. If motion is blocked, use the slider.</span>
  </div>
  <div class="row">
    <label for="tilt">Tilt (fallback)</label>
    <input id="tilt" type="range" min="-60" max="60" step="1" value="0">
  </div>
</div>

<script>
(()=>{
  const cap = document.getElementById('cap');
  const openBtn = document.getElementById('openBtn');
  const pour = document.getElementById('pour');
  const glow = document.getElementById('glow');
  const sparkles = document.getElementById('sparkles');
  const slider = document.getElementById('tilt');
  const permBtn = document.getElementById('permBtn');
  const status = document.getElementById('status');

  let isOpen = false;
  function spawnSparkles(active){
    if(!active){ sparkles.style.opacity=0; sparkles.innerHTML=''; return; }
    sparkles.style.opacity=1; sparkles.innerHTML='';
    for(let i=0;i<8;i++){
      const s = document.createElement('div');
      s.className='sp';
      s.style.left = (60 + Math.random()*24)+'%';
      s.style.top  = (32 + Math.random()*10)+'%';
      s.style.animationDelay = (Math.random()*1.2)+'s';
      s.style.width = s.style.height = (4+Math.random()*6)+'px';
      sparkles.appendChild(s);
    }
  }

  openBtn.addEventListener('click', ()=>{
    if(!isOpen){
      cap.classList.add('open');
      setTimeout(()=>cap.classList.add('hidden'), 450);
      isOpen = true;
      openBtn.textContent = 'Close cap';
      status.textContent = 'Tilt to pour.';
    }else{
      cap.classList.remove('hidden'); // 戻す
      requestAnimationFrame(()=> cap.classList.remove('open'));
      isOpen = false;
      openBtn.textContent = 'Open cap';
      status.textContent = 'Open the cap, then tilt to pour.';
      pour.style.opacity = 0; glow.style.opacity=0; spawnSparkles(false);
    }
  });

  function setAngle(deg){
    const threshold = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pour-threshold')) || 26;
    const pouring = isOpen && Math.abs(deg) >= threshold;
    if(pouring){
      const h = Math.min(200, Math.max(60, (Math.abs(deg)-threshold)*6 + 60));
      pour.style.height = h+'px';
      pour.style.opacity = 1;
      glow.style.opacity = 1;
      spawnSparkles(true);
    }else{
      pour.style.opacity = 0;
      glow.style.opacity = 0;
      spawnSparkles(false);
    }
  }

  // フォールバック：スライダー
  slider.addEventListener('input', e => setAngle(parseFloat(e.target.value)));

  // ジャイロ
  async function enableMotion(){
    try{
      if(typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
        const r=await DeviceMotionEvent.requestPermission();
        if(r!=='granted'){ status.textContent='Motion permission denied. Use the slider below.'; return; }
      }
      window.addEventListener('deviceorientation',(ev)=>{
        let g = ev.gamma; if(typeof g!=='number') return;
        g = Math.max(-60, Math.min(60, g));
        setAngle(g);
      }, true);
      permBtn.style.display='none';
      if(isOpen) status.textContent='Tilt to pour.';
    }catch(e){ console.warn(e); status.textContent='Motion not available. Use the slider.'; }
  }

  const iOS = /iP(hone|od|ad)/.test(navigator.platform) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
  if(iOS && typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
    permBtn.style.display='inline-block';
    permBtn.addEventListener('click', enableMotion);
  }else{
    enableMotion();
  }
})();
</script>
</body>
</html>
