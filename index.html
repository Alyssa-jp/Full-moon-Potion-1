<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Moon Potion – mini</title>
<style>
  :root{ --bottle-width:280px; --pour-threshold:25; --max-tilt:60; --level-min:.02; --cap-open-dx:-32px; --cap-open-dy:-58px; --cap-open-rot:-45deg; }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; font-family:ui-rounded,system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
        background:url("Background.PNG") center/cover no-repeat fixed, radial-gradient(1200px 800px at 30% 20%,#0f1a2b 0%,#090e18 50%,#05060a 100%);
        color:#f7fbff; overflow:hidden; -webkit-user-select:none; user-select:none; touch-action:manipulation;}
  .scene{position:relative; width:100%; height:100%; display:grid; place-items:center;}
  .bottle{position:relative; width:var(--bottle-width); aspect-ratio:280/520; transform-origin:50% 85%;}
  .img,.svg{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; display:block}
  .img{pointer-events:none}
  .capimg{position:absolute; left:50%; top:17%; width:80px; transform:translate(-50%,-50%); transform-origin:50% 70%; transition:transform .35s ease; cursor:pointer; z-index:5}
  .capimg.open{ transform:translate(calc(-50% + var(--cap-open-dx)), calc(-50% + var(--cap-open-dy))) rotate(var(--cap-open-rot)) }
  .stream{ position:absolute; left:50%; top:22%; width:10px; height:0; border-radius:8px;
           background:linear-gradient(#8bd5ff,#3aa9ff 60%,rgba(255,255,255,.9));
           box-shadow:0 0 12px rgba(100,200,255,.6), inset 0 0 12px rgba(255,255,255,.8);
           transition:height .1s ease; transform:rotate(12deg); opacity:.95; display:none }
  .stream.on{ display:block }
  .hud{ position:fixed; left:10px; bottom:10px; display:flex; gap:10px; flex-wrap:wrap; font-size:12px; opacity:.95 }
  .chip{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); backdrop-filter:blur(6px); padding:6px 10px; border-radius:999px }
  .btn{ background:#25a2ff; color:#fff; border:none; padding:8px 10px; border-radius:10px; font-weight:700; cursor:pointer }
  .ghost{ background:rgba(255,255,255,.12) }
  .tiltbar{ position:fixed; right:10px; bottom:10px; width:min(560px,90vw); height:18px; background:rgba(255,255,255,.12); border-radius:999px; overflow:hidden }
  .tiltfill{ height:100%; width:50%; background:linear-gradient(90deg,#42ffb3,#21b1ff) }
</style>
</head>
<body>
<div class="scene">
  <div id="bottle" class="bottle">
    <img class="img" src="Bottle.PNG" alt="Bottle"/>
    <svg class="svg" viewBox="0 0 280 520" aria-hidden="true">
      <defs>
        <clipPath id="clip"><path d="M65 130 Q140 110 215 130 L215 440 Q140 470 65 440 Z"/></clipPath>
        <linearGradient id="lg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#6bd3ff"/><stop offset="80%" stop-color="#1a9cff"/></linearGradient>
      </defs>
      <g clip-path="url(#clip)">
        <rect id="liq" x="62" y="240" width="158" height="220" rx="18" ry="18" fill="url(#lg)"/>
        <ellipse id="surf" cx="140" cy="238" rx="74" ry="16" fill="rgba(255,255,255,.7)"/>
      </g>
    </svg>
    <img id="cap" class="capimg" src="Cap.PNG" alt="cap"/>
    <div id="stream" class="stream"></div>
  </div>
</div>

<div class="hud">
  <div class="chip">角度:<span id="deg">0</span>° / 注ぎ <span id="pour">OFF</span></div>
  <div class="chip">
    <button id="toggle">開ける/閉める</button>
    <button id="shake" class="ghost">シェイク</button>
    <button id="reset" class="ghost">リセット</button>
  </div>
</div>
<div class="tiltbar" id="bar"><div id="fill" class="tiltfill"></div></div>

<script>
(()=> {
  const el = {
    bottle: document.getElementById('bottle'),
    cap: document.getElementById('cap'),
    stream: document.getElementById('stream'),
    liq: document.getElementById('liq'),
    surf: document.getElementById('surf'),
    deg: document.getElementById('deg'),
    pour: document.getElementById('pour'),
    bar: document.getElementById('bar'),
    fill: document.getElementById('fill'),
    btnToggle: document.getElementById('toggle'),
    btnShake: document.getElementById('shake'),
    btnReset: document.getElementById('reset')
  };

  const S = { angle:0, level:1, pouring:false, capOpen:false, raf:null };
  function setAngle(a){
    const max = 60; const c = Math.max(-max, Math.min(max, a));
    S.angle = c; el.bottle.style.transform = `rotate(${c}deg)`;
    el.deg.textContent = c.toFixed(0);
    el.fill.style.width = `${50 + (c/max)*50}%`;
    if (S.capOpen && Math.abs(c) >= 25){ startPour(); } else { stopPour(); }
  }
  function pourLoop(t){
    if(!S.pouring) return;
    S.level = Math.max(0, S.level - 0.3/60); // 固定レートで減る（簡易版）
    const pct = Math.max(0, Math.min(1, S.level));
    const baseY=460, maxH=220, h=maxH*pct, y=baseY-h;
    el.liq.setAttribute('y',y.toFixed(1));
    el.liq.setAttribute('height',h.toFixed(1));
    el.surf.setAttribute('cy',(y-2).toFixed(1));
    if (S.level<=.02){ S.level=0; stopPour(); }
    else { S.raf = requestAnimationFrame(pourLoop); }
  }
  function startPour(){
    if(S.level<=0) return;
    if(!S.pouring){ S.pouring=true; el.pour.textContent='ON'; el.stream.classList.add('on'); S.raf=requestAnimationFrame(pourLoop); }
    el.stream.style.height = (Math.min(70, 8 + Math.abs(S.angle))*4)+'px';
  }
  function stopPour(){
    if(S.pouring){ S.pouring=false; el.pour.textContent='OFF'; el.stream.classList.remove('on'); el.stream.style.height='0'; cancelAnimationFrame(S.raf); S.raf=null; }
  }
  function reset(){ S.level=1; stopPour(); setAngle(0); }

  // スライダーで必ず動く
  function drag(e){
    const r = el.bar.getBoundingClientRect();
    const x = (e.touches? e.touches[0].clientX: e.clientX) - r.left;
    const ratio = Math.max(0, Math.min(1, x/r.width));
    const ang = (ratio - .5) * 120; // -60..60
    setAngle(ang);
  }
  el.bar.addEventListener('mousedown', (e)=>{ drag(e); window.addEventListener('mousemove', drag); });
  window.addEventListener('mouseup', ()=> window.removeEventListener('mousemove', drag));
  el.bar.addEventListener('touchstart', (e)=>{ drag(e); }, {passive:false});
  el.bar.addEventListener('touchmove', (e)=>{ drag(e); }, {passive:false});

  // キャップ＆ボタン
  function toggleCap(){
    S.capOpen = !S.capOpen;
    if (S.capOpen) el.cap.classList.add('open'); else el.cap.classList.remove('open');
    if (!S.capOpen) stopPour();
  }
  el.cap.addEventListener('click', toggleCap);
  el.btnToggle.addEventListener('click', toggleCap);
  el.btnShake.addEventListener('click', ()=> el.bottle.classList.add('jiggle') && setTimeout(()=> el.bottle.classList.remove('jiggle'), 500));
  el.btnReset.addEventListener('click', reset);

  // 初期表示
  setAngle(0);
})();
</script>
</body>
</html>
