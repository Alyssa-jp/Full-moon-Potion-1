<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Potion — Open & Pour (auto detect)</title>
<style>
  :root{
    --stage:min(92vw,520px);
    /* ↓ 口の位置と液体枠：少しずつ%を触れば合う */
    --mouth-x:50.5%;
    --mouth-y:23%;
    --pour-threshold:26;
    --liq-left:15%;
    --liq-top:30%;
    --liq-width:70%;
    --liq-height:52%;
    --liq-rotate-scale:.7;
  }
  html,body{margin:0;height:100%;background:#0b0e16;color:#eaf6ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{min-height:100dvh;display:grid;place-items:center;padding:16px;background:center/cover no-repeat}
  body.has-bg .wrap{background-image:var(--bg-url)}
  .stage{position:relative;width:var(--stage);aspect-ratio:1/1;isolation:isolate}
  .bottle,.cap{position:absolute;inset:0;display:grid;place-items:center}
  .bottle img,.cap img{width:100%;height:auto;filter:drop-shadow(0 12px 30px rgba(0,0,0,.45))}
  .cap{pointer-events:auto}
  .cap img{width:42%;position:absolute;left:50%;top:11%;transform:translate(-50%,0)}
  .cap.open img{transition:transform .45s cubic-bezier(.2,.8,.2,1),opacity .2s;transform:translate(-50%,-60%) rotate(-18deg)}
  .cap.hidden img{opacity:0}
  .liquid-box{position:absolute;left:var(--liq-left);top:var(--liq-top);width:var(--liq-width);height:var(--liq-height);overflow:hidden;border-radius:28%/24%;pointer-events:none}
  .liquid-img{position:absolute;inset:-6% -6% -6% -6%;width:112%;height:112%;object-fit:cover;transform-origin:50% 60%;transition:transform .18s ease-out}
  .stream{position:absolute;left:var(--mouth-x);top:var(--mouth-y);width:5px;height:0;border-radius:3px;background:linear-gradient(#ffd1e3,#ff9cc4, rgba(255,108,166,0));box-shadow:0 0 14px #ff7fb280;transform-origin:top;opacity:0;transition:opacity .12s}
  .drops{position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity .15s}
  .drop{position:absolute;width:7px;height:11px;border-radius:50% 50% 60% 60%;background:#ffd1e3;filter:drop-shadow(0 2px 6px #ff9cc480);animation:fall 1s linear infinite;opacity:.95}
  @keyframes fall{0%{transform:translate(0,0) rotate(8deg)}100%{transform:translate(-6px,120px) rotate(22deg);opacity:0}}
  .hud{position:fixed;inset:auto 0 0 0;padding:12px 16px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.35));display:grid;gap:10px}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .btn{border:1px solid #2a3648;background:#141b27;color:#eaf6ff;padding:8px 12px;border-radius:10px;font-weight:600}
  input[type=range]{width:100%}
  .note{font-size:12px;opacity:.8}
  .brand{position:fixed;top:10px;left:50%;translate:-50% 0;font-size:12px;opacity:.7;letter-spacing:.12em;text-transform:uppercase}
  .diag{position:fixed;top:10px;right:10px;font:12px/1.2 ui-monospace,Menlo,monospace;background:#111a;border:1px solid #39465a;border-radius:8px;padding:8px 10px;white-space:pre;max-width:min(90vw,420px)}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage" id="stage">
    <div class="liquid-box"><img id="liquid" class="liquid-img" alt=""></div>
    <div class="bottle"><img id="bottle" alt="bottle"></div>
    <div class="cap" id="cap"><img id="capimg" alt="cap"></div>
    <div class="stream" id="stream"></div>
    <div class="drops" id="drops"></div>
  </div>
</div>
<div class="brand">PISCES ECLIPSE POTION — © ALYSSA</div>
<div class="hud">
  <div class="row">
    <button class="btn" id="openBtn">Open cap</button>
    <button class="btn" id="permBtn" style="display:none">Enable Motion</button>
    <span class="note" id="status">Open the cap, then tilt to pour. If motion is blocked, use the slider.</span>
  </div>
  <div class="row">
    <label for="tilt">Tilt (fallback)</label>
    <input id="tilt" type="range" min="-60" max="60" step="1" value="0">
  </div>
</div>
<div class="diag" id="diag">loading…</div>

<script>
(async () => {
  const diag = document.getElementById('diag');
  const log = (t) => diag.textContent = t;

  // 候補名から存在するファイルを1つ選ぶ（HEADで確認）
  async function pick(cands){
    for(const p of cands){
      try{ const r = await fetch(p + '?v=' + Date.now(), {method:'HEAD'}); if(r.ok) return p; }catch(_){}
    }
    return null;
  }

  const bottleSrc = await pick(['Bottle.png','bottle.png']);
  const capSrc    = await pick(['Cap.png','cap.png']);
  const liquidSrc = await pick(['Liquid.png','liquid.png']);
  const bgSrc     = await pick(['background.png','Background.png']);

  if(bgSrc){ document.body.classList.add('has-bg'); document.documentElement.style.setProperty('--bg-url', `url("${bgSrc}")`); }

  const bottle = document.getElementById('bottle');
  const capimg = document.getElementById('capimg');
  const liquid = document.getElementById('liquid');

  bottle.src = bottleSrc || '';
  capimg.src = capSrc || '';
  liquid.src = liquidSrc || '';

  log(
    'detect:\n' +
    `bottle: ${bottleSrc || 'NOT FOUND'}\n` +
    `cap   : ${capSrc || 'NOT FOUND'}\n` +
    `liquid: ${liquidSrc || 'NOT FOUND'}\n` +
    (bgSrc ? `bg    : ${bgSrc}\n`:'') +
    (bottleSrc && capSrc && liquidSrc ? 'OK: tap Open cap → tilt' : '⚠ 足りない画像があります')
  );

  const cap = document.getElementById('cap');
  const openBtn = document.getElementById('openBtn');
  const stream = document.getElementById('stream');
  const drops  = document.getElementById('drops');
  const slider = document.getElementById('tilt');
  const permBtn= document.getElementById('permBtn');
  const status = document.getElementById('status');

  let isOpen=false;

  openBtn.onclick=()=>{
    isOpen=!isOpen;
    cap.classList.toggle('open', isOpen);
    openBtn.textContent = isOpen ? 'Close cap' : 'Open cap';
    status.textContent  = isOpen ? 'Tilt to pour.' : 'Open the cap, then tilt to pour.';
    if(!isOpen){ stopPour(); liquid.style.transform='rotate(0deg)'; }
  };

  function stopPour(){ stream.style.opacity=0; drops.style.opacity=0; drops.innerHTML=''; }

  function spawnDrops(active){
    if(!active){ stopPour(); return; }
    drops.style.opacity=1; drops.innerHTML='';
    const rect = document.getElementById('stage').getBoundingClientRect();
    const mx = rect.width * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--mouth-x'))/100;
    const my = rect.height* parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--mouth-y'))/100;
    for(let i=0;i<6;i++){
      const d=document.createElement('div'); d.className='drop';
      d.style.left = (mx + (Math.random()*16-8))+'px';
      d.style.top  = (my + (Math.random()*10-5))+'px';
      d.style.animationDelay = (Math.random()*0.5)+'s';
      d.style.animationDuration = (0.75+Math.random()*0.6)+'s';
      drops.appendChild(d);
    }
  }

  function setAngle(deg){
    if(!isOpen) return;
    const scale = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--liq-rotate-scale')) || .7;
    liquid.style.transform = `rotate(${deg*scale}deg)`;

    const threshold = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pour-threshold')) || 26;
    const pouring = Math.abs(deg) >= threshold;
    if(pouring){
      const h = Math.min(220, Math.max(60, (Math.abs(deg)-threshold)*6 + 60));
      stream.style.height = h+'px';
      stream.style.opacity = 1;
      spawnDrops(true);
    }else{
      stopPour();
    }
  }

  // スライダー
  slider.oninput = e => setAngle(parseFloat(e.target.value));

  // ジャイロ
  async function enableMotion(){
    try{
      if(typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
        const r=await DeviceMotionEvent.requestPermission();
        if(r!=='granted'){ status.textContent='Motion permission denied. Use the slider below.'; return; }
      }
      window.addEventListener('deviceorientation',(ev)=>{
        let g = ev.gamma; if(typeof g!=='number') return;
        g = Math.max(-60, Math.min(60, g));
        setAngle(g);
      }, true);
      permBtn.style.display='none';
      if(isOpen) status.textContent='Tilt to pour.';
    }catch(e){ console.warn(e); status.textContent='Motion not available. Use the slider.'; }
  }
  const iOS = /iP(hone|od|ad)/.test(navigator.platform) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
  if(iOS && typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
    permBtn.style.display='inline-block';
    permBtn.addEventListener('click', enableMotion);
  }else{
    enableMotion();
  }
})();
</script>
</body>
</html>
